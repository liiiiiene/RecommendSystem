from langchain_openai import ChatOpenAI
from langchain_core.prompts import PromptTemplate
from langchain.prompts.few_shot import FewShotPromptTemplate


class LLM_FewShot:
    def __init__(self, prompt_prefix, prompt_suffix, variables):
        OPENAI_API_KEY = "sk-8FHanPyzQG29mIrm125eDf81B0Aa468d93Fd8fCd0b4356Ef"
        OPENAI_API_BASE = "http://openai-proxy.miracleplus.com/v1"
        llm = ChatOpenAI(model='gpt-4o', api_key=OPENAI_API_KEY, base_url=OPENAI_API_BASE)
        
        # å®šä¹‰ç¤ºä¾‹
        examples = [
            {
                "sequeence": 'ï¼ˆ"è§†é¢‘id":10595,"å°é¢æ–‡å­—":å°åº¦å†›é˜Ÿå†æ¬¡éæ³•è¶Šçº¿,"ç®€ä»‹æ ‡é¢˜":å°åº¦å†›é˜Ÿå†æ¬¡éæ³•è¶Šçº¿,"æ ‡é¢˜æ ‡ç­¾":[],"ä¸€çº§æ ‡ç­¾":å†›äº‹,"äºŒçº§æ ‡ç­¾":å†›äº‹å†²çª,"ä¸‰çº§æ ‡ç­¾":UNKNOWNï¼‰->ï¼ˆ"è§†é¢‘id":6502,"å°é¢æ–‡å­—":UNKNOWN,"ç®€ä»‹æ ‡é¢˜":#è°­æ¾éŸµåº­å®¡ç°åœºå“½å’½å‘è¨€ çœŸçš„ä»¤äººå¿ƒç–¼â€¦åº­å®¡åç´§ç´§ä¸äº²å‹ç›¸æ‹¥ ,"æ ‡é¢˜æ ‡ç­¾":[è°­æ¾éŸµåº­å®¡ç°åœºå“½å’½å‘è¨€],"ä¸€çº§æ ‡ç­¾":æ°‘ç”Ÿèµ„è®¯,"äºŒçº§æ ‡ç­¾":ç¤¾ä¼šäº‹ä»¶,"ä¸‰çº§æ ‡ç­¾":ç¤¾ä¼šæ–°é—»ï¼‰->ï¼ˆ"è§†é¢‘id":4944,"å°é¢æ–‡å­—":UNKNOWN,"ç®€ä»‹æ ‡é¢˜":å¼€äº†11å¹´çš„è½¦ï¼Œè¿˜ä¸çŸ¥é“å®‰å…¨å¸¦åŸæœ‰è¿™ç§ç”¨é€”ï¼Œå—æ•™äº†ï¼ #ä¸»æ’­ä¸­å¿ƒ #å¿«æ‰‹åˆ›ä½œè€…ä¸­å¿ƒ ,"æ ‡é¢˜æ ‡ç­¾":[ä¸»æ’­ä¸­å¿ƒ,å¿«æ‰‹åˆ›ä½œè€…ä¸­å¿ƒ],"ä¸€çº§æ ‡ç­¾":æ°‘ç”Ÿèµ„è®¯,"äºŒçº§æ ‡ç­¾":ç¤¾ä¼šäº‹ä»¶,"ä¸‰çº§æ ‡ç­¾":ç¤¾ä¼šæ–°é—»ï¼‰->ï¼ˆ"è§†é¢‘id":4987,"å°é¢æ–‡å­—":UNKNOWN,"ç®€ä»‹æ ‡é¢˜":è¾½å®å¤§é‡ç‰¹è­¦çªè¢­ä¸€è¯åº—ï¼Œå¤šäººè’™å¤´å¥—è¢«æŠ¼ï¼ç›®å‡»è€…ï¼šè¯¥è¯åº—å¼€ä¸šæ‰å‡ ä¸ªæœˆï¼Œçœ‹èµ·æ¥å¾ˆæ™®é€š,"æ ‡é¢˜æ ‡ç­¾":[],"ä¸€çº§æ ‡ç­¾":æ°‘ç”Ÿèµ„è®¯,"äºŒçº§æ ‡ç­¾":ç¤¾ä¼šäº‹ä»¶,"ä¸‰çº§æ ‡ç­¾":æ³•åˆ¶äº‹ä»¶ï¼‰->ï¼ˆ"è§†é¢‘id":1643,"å°é¢æ–‡å­—":UNKNOWN,"ç®€ä»‹æ ‡é¢˜":#é«˜æ¸…è§†é¢‘ #å¹¼å„¿å›­å¼€å­¦ç¿»è½¦ç°åœº ç¡åˆè§‰åˆ°åº•æ˜¯æ‰¾çˆ¸çˆ¸è¿˜æ˜¯æ‰¾å¥¶å¥¶å‘¢ï¼Ÿä½ ä¿©è®©å¦ˆå¦ˆæ€ä¹ˆæƒ³ğŸ˜‚,"æ ‡é¢˜æ ‡ç­¾":[å¹¼å„¿å›­å¼€å­¦ç¿»è½¦ç°åœº,é«˜æ¸…è§†é¢‘],"ä¸€çº§æ ‡ç­¾":æ°‘ç”Ÿèµ„è®¯,"äºŒçº§æ ‡ç­¾":ç¤¾ä¼šäº‹ä»¶,"ä¸‰çº§æ ‡ç­¾":è¶£é—»è¶£äº‹ï¼‰->ï¼ˆ"è§†é¢‘id":7975,"å°é¢æ–‡å­—":UNKNOWN,"ç®€ä»‹æ ‡é¢˜":å¦ç±»â€œç”Ÿæ´»å°å¦™æ‹›â€,"æ ‡é¢˜æ ‡ç­¾":[],"ä¸€çº§æ ‡ç­¾":æ°‘ç”Ÿèµ„è®¯,"äºŒçº§æ ‡ç­¾":ç¤¾ä¼šäº‹ä»¶,"ä¸‰çº§æ ‡ç­¾":è¶£é—»è¶£äº‹ï¼‰->ï¼ˆ"è§†é¢‘id":1667,"å°é¢æ–‡å­—":UNKNOWN,"ç®€ä»‹æ ‡é¢˜":è’™å†¤å…¥ç‹±9778å¤©ï¼Œå¼ ç‰ç¯ç”³è¯·å›½å®¶èµ”å¿2234ä¸‡å…ƒï¼Œè¦æ±‚æ³•é™¢é“æ­‰ï¼,"æ ‡é¢˜æ ‡ç­¾":[],"ä¸€çº§æ ‡ç­¾":æ°‘ç”Ÿèµ„è®¯,"äºŒçº§æ ‡ç­¾":ç¤¾ä¼šäº‹ä»¶,"ä¸‰çº§æ ‡ç­¾":ç¤¾ä¼šæ–°é—»ï¼‰->ï¼ˆ"è§†é¢‘id":3382,"å°é¢æ–‡å­—":UNKNOWN,"ç®€ä»‹æ ‡é¢˜":è¿™ä¿å§†è¿˜èƒ½è¦ä¸,"æ ‡é¢˜æ ‡ç­¾":[],"ä¸€çº§æ ‡ç­¾":äº²å­,"äºŒçº§æ ‡ç­¾":æ™’å¨ƒ,"ä¸‰çº§æ ‡ç­¾":4è‡³12å²èŒå¨ƒï¼‰->ï¼ˆ"è§†é¢‘id":4712,"å°é¢æ–‡å­—":UNKNOWN,"ç®€ä»‹æ ‡é¢˜":æœ‰ä¸€ç§â€œå±è‚¡å¤§â€å«â€œå‡èƒ¯å®½â€ï¼Œè¿™ä¸ªåŠ¨ä½œæ•™ä½ ç»ƒæˆè¿·äººèº«æï¼ #ç‘œä¼½ ,"æ ‡é¢˜æ ‡ç­¾":[ç‘œä¼½],"ä¸€çº§æ ‡ç­¾":å¥èº«,"äºŒçº§æ ‡ç­¾":æ”¾æ¾è®­ç»ƒ,"ä¸‰çº§æ ‡ç­¾":ç‘œä¼½ï¼‰->ï¼ˆ"è§†é¢‘id":5027,"å°é¢æ–‡å­—":UNKNOWN,"ç®€ä»‹æ ‡é¢˜":ä½ çŸ¥é“ä»–æ€ä¹ˆå›å»çš„å—ï¼Ÿ #è·³æ°´ #è½»æ¾ä¸€åˆ»,"æ ‡é¢˜æ ‡ç­¾":[è·³æ°´,è½»æ¾ä¸€åˆ»],"ä¸€çº§æ ‡ç­¾":è¿åŠ¨,"äºŒçº§æ ‡ç­¾":UNKNOWN,"ä¸‰çº§æ ‡ç­¾":UNKNOWNï¼‰', 
                "candidate": 'ï¼ˆè§†é¢‘id:7049,  å°é¢æ–‡å­—:UNKNOWN,  ç®€ä»‹æ ‡é¢˜:#ç¯®çƒ easy bro  #æ‰£ç¯® #çƒåœºå·¥å…·äºº ,  æ ‡é¢˜æ ‡ç­¾:[æ‰£ç¯®,çƒåœºå·¥å…·äºº,ç¯®çƒ],  ä¸€çº§æ ‡ç­¾:è¿åŠ¨,  äºŒçº§æ ‡ç­¾:çƒç±»è¿åŠ¨,  ä¸‰çº§æ ‡ç­¾:ç¯®çƒï¼‰',
                "output": "0.67"
            }
        ]
        
        # ç¤ºä¾‹æ¨¡æ¿
        example_template = """
                        å†å²åºåˆ—: {sequeence}
                        å€™é€‰è§†é¢‘: {candidate}
                        é¢„æµ‹ç‚¹å‡»ç‡: {output}
                        """
        
        example_prompt = PromptTemplate(
            input_variables=["sequeence", "candidate", "output"],
            template=example_template
        )
        
        # åˆ›å»º few-shot æç¤ºæ¨¡æ¿
        few_shot_prompt = FewShotPromptTemplate(
            examples=examples,
            example_prompt=example_prompt,
            prefix=prompt_prefix,
            suffix=prompt_suffix,
            input_variables=variables
        )
        
        self.llm_chain = few_shot_prompt | llm

    def FewShot(self, sequeence, candidate):
        result = self.llm_chain.invoke({
            "sequeence": str(sequeence),
            "candidate": str(candidate)
        })
        return result


# ä½¿ç”¨ç¤ºä¾‹
if __name__ == "__main__":
    prompt_prefix = """ä½ æ˜¯ä¸€ä¸ªè§†é¢‘æ¨èç³»ç»Ÿã€‚æ ¹æ®ç”¨æˆ·è§‚çœ‹å†å²ï¼Œé¢„æµ‹ç”¨æˆ·ç‚¹å‡»æ–°è§†é¢‘çš„æ¦‚ç‡ã€‚
    """
    prompt_suffix = """
    å†å²åºåˆ—: {sequeence}
    å€™é€‰è§†é¢‘: {candidate}

    è¯·æ ¹æ®ä¸Šè¿°å†å²åºåˆ—ï¼Œé¢„æµ‹ç”¨æˆ·ç‚¹å‡»å€™é€‰è§†é¢‘çš„æ¦‚ç‡ã€‚
    è¿”å›ä¸€ä¸ª0åˆ°1ä¹‹é—´çš„æµ®ç‚¹æ•°ï¼Œåªè¿”å›æ•°å­—ï¼Œä¸è¦æœ‰ä»»ä½•è§£é‡Šã€‚
    """
    
    llm_few_shot = LLM_FewShot(prompt_prefix, prompt_suffix, ["sequeence", "candidate"])
    
    # æµ‹è¯•ç¤ºä¾‹
    user_history = "{'è§†é¢‘id': 10595, 'å°é¢æ–‡å­—': 'å°åº¦å†›é˜Ÿå†æ¬¡éæ³•è¶Šçº¿'...}" # è¿™é‡Œæ”¾å®é™…å†å²
    candidate_video = "{è§†é¢‘id:7049, å°é¢æ–‡å­—:UNKNOWN...}" # è¿™é‡Œæ”¾å€™é€‰è§†é¢‘
    
    prediction = llm_few_shot.FewShot(user_history, candidate_video)
    print(f"é¢„æµ‹ç‚¹å‡»ç‡: {prediction.content}")

